<p-card>
  @if (data.length > 0) {
    <p-table
      #saidaEstoqueTable
      [rows]="10"
      dataKey="idString"
      [value]="data"
      [paginator]="true"
      class="table-custom"
      [expandedRowKeys]="expandedRows"
      [rowsPerPageOptions]="[5, 10, 20]"
      styleClass="p-datatable-gridlines"
      (onRowExpand)="onRowExpand($event)"
      (onRowCollapse)="onRowCollapse($event)"
      [tableStyle]="{ 'min-width': '50rem' }"
    >
      <ng-template pTemplate="header">
        <tr>
          <th id="id_th_tabela_acoes" class="text-50 text-center surface-100 text-color w-5rem"></th>
          <th id="id_th_tabela_codigo" class="text-50 text-center surface-100 text-color" pFrozenColumn>Código</th>
          <th id="id_th_tabela_usuario" class="text-50 text-center surface-100 text-color">Usuário</th>
          <th id="id_th_tabela_data_saida" class="text-50 text-center surface-100 text-color">Data de Saida</th>
          <th id="id_th_tabela_descricao" class="text-50 text-center surface-100 text-color">Descrição</th>
          <th id="id_th_tabela_situacao" class="text-50 text-center surface-100 text-color">Situação</th>
          <th id="id_th_tabela_qtd_itens" class="text-50 text-center surface-100 text-color">Qtd Itens</th>
          <th id="id_th_tabela_qtd_itens" class="text-50 text-center surface-100 text-color">Qtd Itens Únicos</th>
          <th id="id_th_tabela_opcoes" class="text-50 text-center surface-100 text-color">Opções</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-saidaEstoque let-expanded="expanded">
        <tr>
          <td>
            <p-button
              pRipple
              type="button"
              [text]="true"
              [rounded]="true"
              severity="secondary"
              [pRowToggler]="saidaEstoque"
              [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
          </td>
          <td class="text-center" pFrozenColumn>{{ saidaEstoque.codigo ?? '-' }}</td>
          <td class="text-center">{{ saidaEstoque.createdBy ?? '-'}}</td>
          <td class="text-center">{{ (saidaEstoque.dataMovimentacaoEstoque | date:'dd/MM/yyyy') ?? '-'}}</td>
          <td class="text-center">{{ saidaEstoque.descricao ?? '-'}}</td>
          <td class="text-center">
            <p-tag [severity]="saidaEstoque.situacao === SITUACAO.CADASTRO_FINALIZADO ? 'success' : 'warn'" [value]="getSituacaoNormalized(saidaEstoque.situacao)" />
          </td>
          <td class="text-center">{{ saidaEstoque.qtdItens ?? '-'}}</td>
          <td class="text-center">{{ saidaEstoque.qtdItensUnicos ?? '-'}}</td>
          <td class="text-center" style="width: 4%; min-width: 5rem">
            <p-button
              [text]="true"
              icon="pi pi-ellipsis-v"
              styleClass="text-color"
              (onClick)="onToggleMenu($event, saidaEstoque)"
            ></p-button>
          </td>
        </tr>
      </ng-template>
      <ng-template #expandedrow let-produtoSaidaEstoque>
        <tr>
          <td colspan="9">
            <div>
              @if (produtoSaidaEstoque.loading) {
                <app-loading></app-loading>
              }
              @else {
                <p-card [header]="`Produtos da saida de estoque de código ${produtoSaidaEstoque.codigo}`">
                  <p-table [value]="produtoSaidaEstoque.produtos" dataKey="idString">
                    <ng-template pTemplate="header">
                      <tr>
                        <th id="id_th_subtabela_produto" class="text-50 text-center surface-100 text-color text-sm">Produto</th>
                        <th id="id_th_subtabela_preco_venda" class="text-50 text-center surface-100 text-color text-sm">Preço de Venda</th>
                        <th id="id_th_subtabela_estoque" class="text-50 text-center surface-100 text-color text-sm">Estoque</th>
                        <th id="id_th_subtabela_quantidade" class="text-50 text-center surface-100 text-color text-sm">Quantidade</th>
                        <th id="id_th_subtabela_desconto" class="text-50 text-center surface-100 text-color text-sm">Desconto</th>
                        <th id="id_th_subtabela_valor_unitario" class="text-50 text-center surface-100 text-color text-sm">Valor Unitário</th>
                        <th id="id_th_subtabela_valor_unitario_desconto" class="text-50 text-center surface-100 text-color text-sm">Valor Unitário com Desconto</th>
                        <th id="id_th_subtabela_valor_final" class="text-50 text-center surface-100 text-color text-sm">Valor Final</th>
                        <th id="id_th_subtabela_valor_final" class="text-50 text-center surface-100 text-color text-sm">Valor Final com Desconto</th>
                        <th id="id_th_subtabela_acoes" class="text-50 text-center surface-100 text-color w-5rem"></th>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-produtoSaida let-expanded="expanded">
                      <tr>
                        <td class="text-center text-sm" pFrozenColumn [pTooltip]="getTooltipMessage(produtoSaida.produto)" tooltipPosition="top">{{ produtoSaida.produto.nome ?? '-' }}</td>
                        <td class="text-center text-sm" pFrozenColumn>{{ (produtoSaida.produto.precoVenda | currency: 'BRL') ?? '-' }}</td>
                        <td class="text-center text-sm" pFrozenColumn>{{ produtoSaida.produto.quantidadeEmEstoque ?? '-' }}</td>
                        <td class="text-center text-sm" pFrozenColumn>{{ produtoSaida.quantidade ?? '-' }}</td>
                        <td class="text-center text-sm" pFrozenColumn>{{ (produtoSaida.desconto | percent) ?? '-' }}</td>
                        <td class="text-center text-sm" pFrozenColumn>{{ (produtoSaida.precoUnitario | currency: 'BRL') ?? '-' }}</td>
                        <td class="text-center text-sm" pFrozenColumn>{{ (getValorUnitarioComDesconto(produtoSaida) | currency: 'BRL') ?? '-' }}</td>
                        <td class="text-center text-sm" pFrozenColumn>{{ (produtoSaida.precoUnitario * produtoSaida.quantidade | currency: 'BRL') ?? '-' }}</td>
                        <td class="text-center text-sm" pFrozenColumn>{{ (getPrecoFinal(produtoSaida) | currency: 'BRL') }}</td>
                        <td>
                          <p-button
                            pRipple
                            type="button"
                            [text]="true"
                            [rounded]="true"
                            icon="pi pi-search"
                            severity="secondary"
                            pTooltip="Visualizar Produto"
                            (onClick)="goToVisualizarProduto(produtoSaida)"/>
                        </td>
                      </tr>
                  </ng-template>
                  </p-table>
                </p-card>
              }
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  }
  <sem-dados [data]="data"></sem-dados>
</p-card>

<p-menu #actionMenu [popup]="true" />
